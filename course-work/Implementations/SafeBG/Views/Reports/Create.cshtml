<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

@model SafeBG.Models.Report

@{
    ViewData["Title"] = "Create";
}

<h1>Create Report</h1>

<hr />
<div class="row">
    <div class="col-md-6">

        <!-- FORM -->
        <form asp-action="Create" method="post">
            <div asp-validation-summary="All" class="text-danger"></div>

            @Html.AntiForgeryToken()

            <!-- Title -->
            <div class="form-group mb-3">
                <label asp-for="Title" class="control-label"></label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <!-- Description -->
            <div class="form-group mb-3">
                <label asp-for="Description" class="control-label"></label>
                <textarea asp-for="Description" class="form-control"></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <!-- Latitude -->
            <div class="form-group mb-3">
                <label asp-for="Latitude" class="control-label"></label>
                <input asp-for="Latitude" id="Latitude" class="form-control" />
                <span asp-validation-for="Latitude" class="text-danger"></span>
            </div>
          
            
            <input type="hidden" asp-for="Address" id="AddressHidden" />

            <!-- Longitude -->
            <div class="form-group mb-3">
                <label asp-for="Longitude" class="control-label"></label>
                <input asp-for="Longitude" id="Longitude" class="form-control" />
                <span asp-validation-for="Longitude" class="text-danger"></span>
            </div>
            


            <!-- ADDRESS (auto detected) -->
            <div class="form-group mb-3">
                <label>Detected Address</label>
                <input id="Address" class="form-control" readonly />
            </div>

            <!-- MAP -->
            <div id="map" style="height: 400px; margin-bottom: 20px; border: 2px solid #ccc;"></div>

            <!-- City -->
            <div class="form-group mb-3">
                <label asp-for="CityId" class="control-label"></label>
                <select asp-for="CityId" id="CityId" class="form-control" asp-items="ViewBag.CityId"></select>
                <span asp-validation-for="CityId" class="text-danger"></span>
            </div>

            <!-- Category -->
            <div class="form-group mb-3">
                <label asp-for="CategoryId" class="control-label"></label>
                <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.CategoryId"></select>
                <span asp-validation-for="CategoryId" class="text-danger"></span>
            </div>

            <div class="form-group mt-4">
                <button type="submit" class="btn btn-primary w-100">Create</button>
            </div>

        </form>

    </div>
</div>

<div class="mt-3">
    <a asp-action="Index">Back to List</a>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    var map = L.map('map').setView([42.6977, 23.3219], 7);



    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var marker;

    function setMarker(lat, lng) {
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }
    }

    map.on('click', async function (e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        setMarker(lat, lng);

        document.getElementById("Latitude").value = lat;
        document.getElementById("Longitude").value = lng;

        // Reverse geocoding
        let url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`;

        let response = await fetch(url, {
            headers: {
                "User-Agent": "SafeBG",
                "Accept-Language": "bg"
            }
        });

        let data = await response.json();
    
        if (data && data.display_name) {
            document.getElementById("AddressHidden").value = data.display_name;
        }


        // Set full address
        document.getElementById("Address").value = data.display_name;

        // Get city name
        let cityName =
            data.address.city ||
            data.address.town ||
            data.address.village ||
            data.address.municipality ||
            data.address.county;

        if (cityName) {
            let cityDropdown = document.getElementById("CityId");
            for (let option of cityDropdown.options) {
                if (option.text.toLowerCase() === cityName.toLowerCase()) {
                    option.selected = true;
                    break;
                }
            }
        }
    });
</script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
